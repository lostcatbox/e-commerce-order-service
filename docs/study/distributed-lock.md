# ë¶„ì‚°ë½ ì‚¬ìš© ì´ìœ 
- DB íŠ¸ëœì­ì…˜ ì´ìƒì˜ ë²”ìœ„, ë¶„ì‚° í™˜ê²½ì—ì„œ Lock ì„ ì ìš©í•  ìˆ˜ ìˆëŠ” ë°©ë²•
- ë‹¤ëŸ‰ì˜ íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì ì€ DB ë¶€í•˜ë¡œ ì˜¬ë°”ë¥´ê²Œ ê¸°ëŠ¥ì„ ì œê³µí•  ë°©ë²•

# ë¶„ì‚°ë½ ì´ë€?
- ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤, ì„œë²„, ì¸ìŠ¤í„´ìŠ¤ì— ê±¸ì³ ìì›ì— ëŒ€í•œ ë™ì‹œ ì ‘ê·¼ì„ ì œì–´í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜
- ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ë°ì´í„° ì¼ê´€ì„±ê³¼ ë¬´ê²°ì„±ì„ ìœ ì§€í•˜ëŠ” ë° ì¤‘ìš”
- ì˜ˆì‹œ: Redis ë“±ì„ í™œìš©í•œ ë¶„ì‚°
  - Redis ê¸°ë°˜ì˜ ë¶„ì‚°ë½
  - key-value ê¸°ë°˜ì˜ ì›ìì„±ì„ ì´ìš©í•œ Redis ë¥¼ í†µí•´ DB ë¶€í•˜ë¥¼ ìµœì†Œí™”í•˜ëŠ” Lock ì„ ì„¤ê³„

# ë¶„ì‚°ë½ ì‚¬ìš© ì‹œ ê³ ë ¤ì‚¬í•­
- Redis ë½ê³¼ íŠ¸ëœì­ì…˜ ë™ì‹œ ì‚¬ìš© ì‹œ ì£¼ì˜
  - Redis ë½ì€ DB íŠ¸ëœì­ì…˜ê³¼ ë³„ê°œë¡œ ë™ì‘
  - ë°˜ë“œì‹œ **ë½ íšë“ -> íŠ¸ëœì­ì…˜ ì‹œì‘ -> ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰ -> íŠ¸ëœì­ì…˜ ì¢…ë£Œ -> ë½ í•´ì œ ìˆœì„œë¡œ ì§„í–‰**
    - ë§Œì•½ **íŠ¸ëœì­ì…˜ ì‹œì‘**ì´ **ë½ íšë“**ë³´ë‹¤ ë¨¼ì €ë¼ë©´, ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ ë°ì´í„° ì¡°íšŒ + ìˆ˜ì •ì´ ê°€ëŠ¥í•´ì ¸ì„œ ë™ì‹œì„± ì´ìŠˆ ë°œìƒ
    - ë§Œì•½ **íŠ¸ëœì­ì…˜ ì¢…ë£Œ**ê°€ **ë½ í•´ì œ**ë³´ë‹¤ ë‚˜ì¤‘ì´ë¼ë©´, ë½ì´ í•´ì œëœ í›„ ë°”ë¡œ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ë½ì„ íšë“í•˜ì—¬ ë°ì´í„° ë³€ê²½ì´ ê°€ëŠ¥í•´ì ¸ì„œ ë™ì‹œì„± ì´ìŠˆ ë°œìƒ

## Redis ë¶„ì‚°ë½ê³¼ íŠ¸ëœì­ì…˜ ìˆœì„œë³„ ì¼€ì´ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

### (ì •ìƒ ìœ í˜•) ì˜¬ë°”ë¥¸ ë½ê³¼ íŠ¸ëœì­ì…˜ ìˆœì„œ
ë½ íšë“ â†’ íŠ¸ëœì­ì…˜ ì‹œì‘ â†’ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰ â†’ íŠ¸ëœì­ì…˜ ì¢…ë£Œ â†’ ë½ í•´ì œ

```mermaid
sequenceDiagram
    participant A as Transaction A
    participant Redis as Redis
    participant DB as Database
    participant B as Transaction B

    Note over A,B: ì˜¬ë°”ë¥¸ ìˆœì„œ: ë½ íšë“ â†’ íŠ¸ëœì­ì…˜ ì‹œì‘ â†’ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ â†’ íŠ¸ëœì­ì…˜ ì¢…ë£Œ â†’ ë½ í•´ì œ

    A->>Redis: 1. ë½ íšë“ ì‹œë„
    Redis-->>A: ë½ íšë“ ì„±ê³µ

    B->>Redis: 1. ë½ íšë“ ì‹œë„
    Redis-->>B: ë½ íšë“ ì‹¤íŒ¨ (ëŒ€ê¸°)

    A->>DB: 2. íŠ¸ëœì­ì…˜ ì‹œì‘ (BEGIN)
    A->>DB: 3. ë°ì´í„° ì¡°íšŒ (SELECT)
    DB-->>A: ë°ì´í„° ë°˜í™˜
    A->>DB: 4. ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰ (UPDATE/INSERT)
    A->>DB: 5. íŠ¸ëœì­ì…˜ ì»¤ë°‹ (COMMIT)
    DB-->>A: ì»¤ë°‹ ì™„ë£Œ

    A->>Redis: 6. ë½ í•´ì œ
    Redis-->>A: ë½ í•´ì œ ì™„ë£Œ

    B->>Redis: ë½ íšë“ ì¬ì‹œë„
    Redis-->>B: ë½ íšë“ ì„±ê³µ

    B->>DB: íŠ¸ëœì­ì…˜ ì‹œì‘ (BEGIN)
    B->>DB: ë°ì´í„° ì¡°íšŒ (ìµœì‹  ë°ì´í„°)
    DB-->>B: ì—…ë°ì´íŠ¸ëœ ë°ì´í„° ë°˜í™˜
    B->>DB: ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰
    B->>DB: íŠ¸ëœì­ì…˜ ì»¤ë°‹ (COMMIT)
    B->>Redis: ë½ í•´ì œ
```

### (ë¬¸ì œ ë°œìƒ) íŠ¸ëœì­ì…˜ ì‹œì‘ì´ ë½ íšë“ë³´ë‹¤ ë¨¼ì €
íŠ¸ëœì­ì…˜ ì‹œì‘ â†’ ë½ íšë“ â†’ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰ â†’ íŠ¸ëœì­ì…˜ ì¢…ë£Œ â†’ ë½ í•´ì œ

```mermaid
sequenceDiagram
    participant A as Transaction A
    participant Redis as Redis
    participant DB as Database
    participant B as Transaction B

    Note over A,B: âŒ ì˜ëª»ëœ ìˆœì„œ: íŠ¸ëœì­ì…˜ ì‹œì‘ â†’ ë½ íšë“ (ë™ì‹œì„± ì´ìŠˆ ë°œìƒ)

    A->>DB: 1. íŠ¸ëœì­ì…˜ ì‹œì‘ (BEGIN) - ë½ ì—†ì´!
    B->>DB: 1. íŠ¸ëœì­ì…˜ ì‹œì‘ (BEGIN) - ë½ ì—†ì´!

    A->>DB: 2. ë°ì´í„° ì¡°íšŒ (SELECT balance = 1000)
    B->>DB: 2. ë°ì´í„° ì¡°íšŒ (SELECT balance = 1000) - ê°™ì€ ê°’!

    A->>Redis: 3. ë½ íšë“ ì‹œë„
    Redis-->>A: ë½ íšë“ ì„±ê³µ

    B->>Redis: 3. ë½ íšë“ ì‹œë„
    Redis-->>B: ë½ íšë“ ì‹¤íŒ¨ (ëŒ€ê¸°)

    A->>DB: 4. ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ (balance + 500 = 1500)
    A->>DB: 5. íŠ¸ëœì­ì…˜ ì»¤ë°‹ (COMMIT)
    DB-->>A: ì»¤ë°‹ ì™„ë£Œ (balance = 1500)

    A->>Redis: 6. ë½ í•´ì œ

    B->>Redis: ë½ íšë“ ì¬ì‹œë„
    Redis-->>B: ë½ íšë“ ì„±ê³µ

    Note over B: âš ï¸ BëŠ” ì´ë¯¸ ì¡°íšŒí•œ ì˜ëª»ëœ ë°ì´í„°(1000)ë¡œ ë¡œì§ ìˆ˜í–‰
    B->>DB: ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ (1000 + 300 = 1300) - ì˜ëª»ëœ ê³„ì‚°!
    B->>DB: íŠ¸ëœì­ì…˜ ì»¤ë°‹ (COMMIT)
    DB-->>B: ì»¤ë°‹ ì™„ë£Œ (balance = 1300)

    Note over A,B: ğŸ’¥ ê²°ê³¼: 1000 + 500 + 300 = 1800ì´ì–´ì•¼ í•˜ì§€ë§Œ 1300ì´ ë¨
```

### (ë¬¸ì œ ë°œìƒ) íŠ¸ëœì­ì…˜ ì¢…ë£Œê°€ ë½ í•´ì œë³´ë‹¤ ë‚˜ì¤‘
ë½ íšë“ â†’ íŠ¸ëœì­ì…˜ ì‹œì‘ â†’ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰ â†’ ë½ í•´ì œ â†’ íŠ¸ëœì­ì…˜ ì¢…ë£Œ

```mermaid
sequenceDiagram
    participant A as Transaction A
    participant Redis as Redis
    participant DB as Database
    participant B as Transaction B

    Note over A,B: âŒ ì˜ëª»ëœ ìˆœì„œ: ë½ í•´ì œ â†’ íŠ¸ëœì­ì…˜ ì¢…ë£Œ (ë™ì‹œì„± ì´ìŠˆ ë°œìƒ)

    A->>Redis: 1. ë½ íšë“
    Redis-->>A: ë½ íšë“ ì„±ê³µ

    B->>Redis: 1. ë½ íšë“ ì‹œë„
    Redis-->>B: ë½ íšë“ ì‹¤íŒ¨ (ëŒ€ê¸°)

    A->>DB: 2. íŠ¸ëœì­ì…˜ ì‹œì‘ (BEGIN)
    A->>DB: 3. ë°ì´í„° ì¡°íšŒ (SELECT balance = 1000)
    A->>DB: 4. ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰ (balance + 500)

    Note over A: âš ï¸ íŠ¸ëœì­ì…˜ì€ ì•„ì§ ì»¤ë°‹ë˜ì§€ ì•ŠìŒ
    A->>Redis: 5. ë½ í•´ì œ (ë„ˆë¬´ ì´ë¥¸ í•´ì œ!)
    Redis-->>A: ë½ í•´ì œ ì™„ë£Œ

    B->>Redis: ë½ íšë“ ì¬ì‹œë„
    Redis-->>B: ë½ íšë“ ì„±ê³µ

    B->>DB: íŠ¸ëœì­ì…˜ ì‹œì‘ (BEGIN)
    B->>DB: ë°ì´í„° ì¡°íšŒ (SELECT balance = 1000) - Aì˜ ë³€ê²½ì‚¬í•­ ë¯¸ë°˜ì˜!

    A->>DB: 6. íŠ¸ëœì­ì…˜ ì»¤ë°‹ (COMMIT) - ëŠ¦ì€ ì»¤ë°‹
    DB-->>A: ì»¤ë°‹ ì™„ë£Œ (balance = 1500)

    B->>DB: ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ (1000 + 300 = 1300)
    B->>DB: íŠ¸ëœì­ì…˜ ì»¤ë°‹ (COMMIT)
    DB-->>B: ì»¤ë°‹ ì™„ë£Œ (balance = 1300) - Aì˜ ë³€ê²½ì‚¬í•­ ë®ì–´ì”€!

    B->>Redis: ë½ í•´ì œ

    Note over A,B: ğŸ’¥ ê²°ê³¼: Aì˜ +500 ë³€ê²½ì‚¬í•­ì´ ìœ ì‹¤ë¨ (Lost Update)
```
