# ë¶„ì‚°ë½ ì´ë€?
- ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤, ì„œë²„, ì¸ìŠ¤í„´ìŠ¤ì— ê±¸ì³ ìì›ì— ëŒ€í•œ ë™ì‹œ ì ‘ê·¼ì„ ì œì–´í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜
- ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ë°ì´í„° ì¼ê´€ì„±ê³¼ ë¬´ê²°ì„±ì„ ìœ ì§€í•˜ëŠ” ë° ì¤‘ìš”
- ì˜ˆì‹œ: Redis ë“±ì„ í™œìš©í•œ ë¶„ì‚°
  - Redis ê¸°ë°˜ì˜ ë¶„ì‚°ë½
  - key-value ê¸°ë°˜ì˜ ì›ìì„±ì„ ì´ìš©í•œ Redis ë¥¼ í†µí•´ DB ë¶€í•˜ë¥¼ ìµœì†Œí™”í•˜ëŠ” Lock ì„ ì„¤ê³„

## ë¶„ì‚°ë½ ì‚¬ìš© ì‹œ ê³ ë ¤ì‚¬í•­
- Redis ë½ê³¼ íŠ¸ëœì­ì…˜ ë™ì‹œ ì‚¬ìš© ì‹œ ì£¼ì˜
  - Redis ë½ì€ DB íŠ¸ëœì­ì…˜ê³¼ ë³„ê°œë¡œ ë™ì‘
  - ë°˜ë“œì‹œ **ë½ íšë“ -> íŠ¸ëœì­ì…˜ ì‹œì‘ -> ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰ -> íŠ¸ëœì­ì…˜ ì¢…ë£Œ -> ë½ í•´ì œ ìˆœì„œë¡œ ì§„í–‰**
    - ë§Œì•½ **íŠ¸ëœì­ì…˜ ì‹œì‘**ì´ **ë½ íšë“**ë³´ë‹¤ ë¨¼ì €ë¼ë©´, ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ ë°ì´í„° ì¡°íšŒ + ìˆ˜ì •ì´ ê°€ëŠ¥í•´ì ¸ì„œ ë™ì‹œì„± ì´ìŠˆ ë°œìƒ
    - ë§Œì•½ **íŠ¸ëœì­ì…˜ ì¢…ë£Œ**ê°€ **ë½ í•´ì œ**ë³´ë‹¤ ë‚˜ì¤‘ì´ë¼ë©´, ë½ì´ í•´ì œëœ í›„ ë°”ë¡œ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ë½ì„ íšë“í•˜ì—¬ ë°ì´í„° ë³€ê²½ì´ ê°€ëŠ¥í•´ì ¸ì„œ ë™ì‹œì„± ì´ìŠˆ ë°œìƒ
  - ë”°ë¼ì„œ ë¶„ì‚°ë½ì€ ê¸°ë³¸ì ìœ¼ë¡œ **ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜**ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥
    - ë”°ë¼ì„œ ìš”ì²­ì— ëŒ€í•´ì„œ ê¸°ì¡´ íŠ¸ëœì­ì…˜ + ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì¸í•´ ë‘ ë²ˆì˜ DB ì»¤ë„¥ì…˜ì´ ë°œìƒí•  ìˆ˜ ìˆìŒ -> **ì»¤ë„¥ì…˜ í’€ ì‚¬ì´ì¦ˆë¥¼ ì¶©ë¶„íˆ í™•ë³´í•´ì•¼ í•¨**

## ë¶„ì‚°ë½ ì ìš©ê³¼ ë¯¸ì ìš© ì¼€ì´ìŠ¤

### ë¶„ì‚°ë½ì„ ì ìš©í•œ ì¼€ì´ìŠ¤
#### ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ ìš”ì²­
- ì¿ í° ë°œê¸‰ì€ ì§§ì€ ì‹œê°„ì— ìˆ˜ë§ì€ ì‚¬ìš©ìê°€ ë™ì‹œì— ìš”ì²­í•œë‹¤.
- ë¶„ì‚°í™˜ê²½ì´ í•„ìš”í•˜ë©°, ì´ë•Œ ë¶„ì‚°ë½ì„ ì ìš©í•˜ì—¬ DB IO ë¹„ìš©ì„ ì¤„ì´ê³ , ë™ì‹œì„± ì´ìŠˆë¥¼ ë°©ì§€í•˜ëŠ” ê²ƒì´ íš¨ê³¼ì ì´ë‹¤.

### ë¶„ì‚°ë½ì„ ì ìš©í•˜ì§€ ì•Šì€ ì¼€ì´ìŠ¤

#### ìƒí’ˆ ì¬ê³  ì°¨ê°
- OrderFacadeì—ì„œ ìƒìœ„ íŠ¸ëœì­ì…˜ì´ ì¡´ì¬í•œë‹¤.
- DB ì»¤ë„¥ì…˜ í’€ì´ ì¶©ë¶„íˆ í™•ë³´ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´, ë¶„ì‚°ë½ì„ ìœ„í•œ ì¶”ê°€ì ì¸ íŠ¸ëœì­ì…˜ì„ ë§Œë“¤ ìˆ˜ ì—†ëŠ” ìƒí™©ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
- ë”°ë¼ì„œ ê¸°ì¡´ëŒ€ë¡œ ë°°íƒ€ë½ì„ ì‚¬ìš©í•˜ì—¬ íŠ¸ëœì­ì…˜ ë²”ìœ„ ë‚´ì—ì„œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ë” ì•ˆì „í•˜ë‹¤.

#### ì‚¬ìš©ì í¬ì¸íŠ¸ ì‚¬ìš© ë° ì¶©ì „
- ìƒìœ„ íŠ¸ëœì­ì…˜ì´ ì¡´ì¬í•  ìˆ˜ ìˆë‹¤.(ì£¼ë¬¸, ê²°ì œ ë“±ì˜ ìƒí™©)
- DB ì»¤ë„¥ì…˜ í’€ì´ ì¶©ë¶„íˆ í™•ë³´ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´, ë¶„ì‚°ë½ì„ ìœ„í•œ ì¶”ê°€ì ì¸ íŠ¸ëœì­ì…˜ì„ ë§Œë“¤ ìˆ˜ ì—†ëŠ” ìƒí™©ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
- ë”°ë¼ì„œ ê¸°ì¡´ëŒ€ë¡œ ë°°íƒ€ë½ì„ ì‚¬ìš©í•˜ì—¬ íŠ¸ëœì­ì…˜ ë²”ìœ„ ë‚´ì—ì„œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ë” ì•ˆì „í•˜ë‹¤.


## Redis ë¶„ì‚°ë½ê³¼ íŠ¸ëœì­ì…˜ ìˆœì„œì— ë”°ë¥¸ ë¬¸ì œ ì‚¬ë¡€

### (ì •ìƒ ìœ í˜•) ì˜¬ë°”ë¥¸ ë½ê³¼ íŠ¸ëœì­ì…˜ ìˆœì„œ
ë½ íšë“ â†’ íŠ¸ëœì­ì…˜ ì‹œì‘ â†’ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰ â†’ íŠ¸ëœì­ì…˜ ì¢…ë£Œ â†’ ë½ í•´ì œ

```mermaid
sequenceDiagram
    participant A as Transaction A
    participant Redis as Redis
    participant DB as Database
    participant B as Transaction B

    Note over A,B: ì˜¬ë°”ë¥¸ ìˆœì„œ: ë½ íšë“ â†’ íŠ¸ëœì­ì…˜ ì‹œì‘ â†’ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ â†’ íŠ¸ëœì­ì…˜ ì¢…ë£Œ â†’ ë½ í•´ì œ

    A->>Redis: 1. ë½ íšë“ ì‹œë„
    Redis-->>A: ë½ íšë“ ì„±ê³µ

    B->>Redis: 1. ë½ íšë“ ì‹œë„
    Redis-->>B: ë½ íšë“ ì‹¤íŒ¨ (ëŒ€ê¸°)

    A->>DB: 2. íŠ¸ëœì­ì…˜ ì‹œì‘ (BEGIN)
    A->>DB: 3. ë°ì´í„° ì¡°íšŒ (SELECT)
    DB-->>A: ë°ì´í„° ë°˜í™˜
    A->>DB: 4. ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰ (UPDATE/INSERT)
    A->>DB: 5. íŠ¸ëœì­ì…˜ ì»¤ë°‹ (COMMIT)
    DB-->>A: ì»¤ë°‹ ì™„ë£Œ

    A->>Redis: 6. ë½ í•´ì œ
    Redis-->>A: ë½ í•´ì œ ì™„ë£Œ

    B->>Redis: ë½ íšë“ ì¬ì‹œë„
    Redis-->>B: ë½ íšë“ ì„±ê³µ

    B->>DB: íŠ¸ëœì­ì…˜ ì‹œì‘ (BEGIN)
    B->>DB: ë°ì´í„° ì¡°íšŒ (ìµœì‹  ë°ì´í„°)
    DB-->>B: ì—…ë°ì´íŠ¸ëœ ë°ì´í„° ë°˜í™˜
    B->>DB: ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰
    B->>DB: íŠ¸ëœì­ì…˜ ì»¤ë°‹ (COMMIT)
    B->>Redis: ë½ í•´ì œ
```

### (ë¬¸ì œ ë°œìƒ) íŠ¸ëœì­ì…˜ ì‹œì‘ì´ ë½ íšë“ë³´ë‹¤ ë¨¼ì €
íŠ¸ëœì­ì…˜ ì‹œì‘ â†’ ë½ íšë“ â†’ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰ â†’ íŠ¸ëœì­ì…˜ ì¢…ë£Œ â†’ ë½ í•´ì œ

```mermaid
sequenceDiagram
    participant A as Transaction A
    participant Redis as Redis
    participant DB as Database
    participant B as Transaction B

    Note over A,B: âŒ ì˜ëª»ëœ ìˆœì„œ: íŠ¸ëœì­ì…˜ ì‹œì‘ â†’ ë½ íšë“ (ë™ì‹œì„± ì´ìŠˆ ë°œìƒ)

    A->>DB: 1. íŠ¸ëœì­ì…˜ ì‹œì‘ (BEGIN) - ë½ ì—†ì´!
    B->>DB: 1. íŠ¸ëœì­ì…˜ ì‹œì‘ (BEGIN) - ë½ ì—†ì´!

    A->>DB: 2. ë°ì´í„° ì¡°íšŒ (SELECT balance = 1000)
    B->>DB: 2. ë°ì´í„° ì¡°íšŒ (SELECT balance = 1000) - ê°™ì€ ê°’!

    A->>Redis: 3. ë½ íšë“ ì‹œë„
    Redis-->>A: ë½ íšë“ ì„±ê³µ

    B->>Redis: 3. ë½ íšë“ ì‹œë„
    Redis-->>B: ë½ íšë“ ì‹¤íŒ¨ (ëŒ€ê¸°)

    A->>DB: 4. ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ (balance + 500 = 1500)
    A->>DB: 5. íŠ¸ëœì­ì…˜ ì»¤ë°‹ (COMMIT)
    DB-->>A: ì»¤ë°‹ ì™„ë£Œ (balance = 1500)

    A->>Redis: 6. ë½ í•´ì œ

    B->>Redis: ë½ íšë“ ì¬ì‹œë„
    Redis-->>B: ë½ íšë“ ì„±ê³µ

    Note over B: âš ï¸ BëŠ” ì´ë¯¸ ì¡°íšŒí•œ ì˜ëª»ëœ ë°ì´í„°(1000)ë¡œ ë¡œì§ ìˆ˜í–‰
    B->>DB: ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ (1000 + 300 = 1300) - ì˜ëª»ëœ ê³„ì‚°!
    B->>DB: íŠ¸ëœì­ì…˜ ì»¤ë°‹ (COMMIT)
    DB-->>B: ì»¤ë°‹ ì™„ë£Œ (balance = 1300)

    Note over A,B: ğŸ’¥ ê²°ê³¼: 1000 + 500 + 300 = 1800ì´ì–´ì•¼ í•˜ì§€ë§Œ 1300ì´ ë¨
```

### (ë¬¸ì œ ë°œìƒ) íŠ¸ëœì­ì…˜ ì¢…ë£Œê°€ ë½ í•´ì œë³´ë‹¤ ë‚˜ì¤‘
ë½ íšë“ â†’ íŠ¸ëœì­ì…˜ ì‹œì‘ â†’ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰ â†’ ë½ í•´ì œ â†’ íŠ¸ëœì­ì…˜ ì¢…ë£Œ

```mermaid
sequenceDiagram
    participant A as Transaction A
    participant Redis as Redis
    participant DB as Database
    participant B as Transaction B

    Note over A,B: âŒ ì˜ëª»ëœ ìˆœì„œ: ë½ í•´ì œ â†’ íŠ¸ëœì­ì…˜ ì¢…ë£Œ (ë™ì‹œì„± ì´ìŠˆ ë°œìƒ)

    A->>Redis: 1. ë½ íšë“
    Redis-->>A: ë½ íšë“ ì„±ê³µ

    B->>Redis: 1. ë½ íšë“ ì‹œë„
    Redis-->>B: ë½ íšë“ ì‹¤íŒ¨ (ëŒ€ê¸°)

    A->>DB: 2. íŠ¸ëœì­ì…˜ ì‹œì‘ (BEGIN)
    A->>DB: 3. ë°ì´í„° ì¡°íšŒ (SELECT balance = 1000)
    A->>DB: 4. ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰ (balance + 500)

    Note over A: âš ï¸ íŠ¸ëœì­ì…˜ì€ ì•„ì§ ì»¤ë°‹ë˜ì§€ ì•ŠìŒ
    A->>Redis: 5. ë½ í•´ì œ (ë„ˆë¬´ ì´ë¥¸ í•´ì œ!)
    Redis-->>A: ë½ í•´ì œ ì™„ë£Œ

    B->>Redis: ë½ íšë“ ì¬ì‹œë„
    Redis-->>B: ë½ íšë“ ì„±ê³µ

    B->>DB: íŠ¸ëœì­ì…˜ ì‹œì‘ (BEGIN)
    B->>DB: ë°ì´í„° ì¡°íšŒ (SELECT balance = 1000) - Aì˜ ë³€ê²½ì‚¬í•­ ë¯¸ë°˜ì˜!

    A->>DB: 6. íŠ¸ëœì­ì…˜ ì»¤ë°‹ (COMMIT) - ëŠ¦ì€ ì»¤ë°‹
    DB-->>A: ì»¤ë°‹ ì™„ë£Œ (balance = 1500)

    B->>DB: ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ (1000 + 300 = 1300)
    B->>DB: íŠ¸ëœì­ì…˜ ì»¤ë°‹ (COMMIT)
    DB-->>B: ì»¤ë°‹ ì™„ë£Œ (balance = 1300) - Aì˜ ë³€ê²½ì‚¬í•­ ë®ì–´ì”€!

    B->>Redis: ë½ í•´ì œ

    Note over A,B: ğŸ’¥ ê²°ê³¼: Aì˜ +500 ë³€ê²½ì‚¬í•­ì´ ìœ ì‹¤ë¨ (Lost Update)
```
