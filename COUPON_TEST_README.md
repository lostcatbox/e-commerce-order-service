# 쿠폰 발급 시스템 통합 테스트 가이드

Kafka 기반 비동기 쿠폰 발급 시스템의 전체 플로우를 테스트하는 가이드입니다.

## 📋 테스트 개요

이 테스트는 다음을 검증합니다:
- **비동기 쿠폰 발급**: Kafka를 통한 이벤트 기반 처리
- **동시성 제어**: 분산락을 통한 재고 관리
- **Consumer 스케일 아웃**: 파티션 분산 처리

## 🚀 테스트 실행 방법

### 1단계: 서버 시작
```bash
./start.sh
```

**실행되는 서비스:**
- MySQL (포트: 3406)
- Redis (포트: 6379)
- Kafka (포트: 9092)
- Kafka UI (포트: 9090)
- Coupon 서버 (포트: 8081)
- Core 서버 (포트: 8080)

### 2단계: 기본 테스트 실행
```bash
./test-coupon-issue.sh
```

**테스트 내용:**
- 데이터베이스 초기화 (쿠폰 3개, 유저 3명)
- 쿠폰 발급 API 테스트 (9개 요청: 3유저 × 3쿠폰)
- Consumer 처리 확인
- 결과 분석

### 3단계: 스케일 아웃 테스트
```bash
# Consumer 스케일 아웃
./coupon-consumer-scale-out.sh

# 스케일 아웃 후 다시 테스트
./test-coupon-issue.sh
```

**스케일 아웃 효과:**
- Consumer 인스턴스 2개 추가 실행
- 하나의 토픽에 3개의 Consumer가 각각의 파티션 할당
- 병렬 처리로 성능 향상 확인

## 📊 예상 결과

### ✅ 성공적인 테스트 결과
```
🚀 쿠폰 발급 시스템 테스트 시작
================================================
ℹ️  MySQL 연결 테스트 중...
✅ MySQL 연결 성공
ℹ️  데이터베이스 초기화 중...
✅ 데이터베이스 초기화 완료
ℹ️  쿠폰 서비스 상태 확인 중...
✅ 쿠폰 서비스 정상 동작 중
ℹ️  쿠폰 발급 API 테스트 시작...
✅ 유저 1 -> 쿠폰 1 발급 요청 성공
✅ 유저 1 -> 쿠폰 2 발급 요청 성공
...
✅ Consumer가 쿠폰을 성공적으로 발급했습니다!
🎉 테스트 완료!
```

### 📈 데이터베이스 결과
- `user_coupon` 테이블에 9개의 레코드 생성
- 각 쿠폰의 `stock`이 1씩 감소 (10 → 7)
- 각 유저가 3개의 쿠폰을 발급받음

## 🔍 테스트 시나리오

### 시나리오 1: 정상 플로우
1. **API 요청**: 3명의 유저가 각각 3개의 쿠폰 발급 요청 (총 9개)
2. **이벤트 발행**: 각 요청이 Kafka 토픽으로 이벤트 발행
3. **Consumer 처리**: Consumer가 이벤트를 순차적으로 처리
4. **결과 확인**: 총 9개의 쿠폰이 발급됨

### 시나리오 2: 스케일 아웃 테스트
1. **Consumer 확장**: 2개의 추가 Consumer 인스턴스 실행
2. **파티션 분산**: 3개의 Consumer가 각각의 파티션 할당
3. **병렬 처리**: 동시에 여러 이벤트 처리 가능
4. **성능 향상**: 처리 속도 개선 확인

### 시나리오 3: 동시성 제어
- 동일한 쿠폰에 대해 여러 유저가 동시에 요청
- 분산락을 통한 동시성 제어 확인
- 재고 정합성 보장 확인

## 🎯 테스트 완료 후 정리

```bash
# 서비스 중지
./stop.sh

# 또는 수동으로 중지
docker-compose down
```
